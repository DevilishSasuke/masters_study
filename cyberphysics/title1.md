# Оптимизация точности малых моделей детекции объектов

## Постановка задачи

В задачах компьютерного зрения, где требуется распознавание объектов в режиме реального времени на мобильных и малопроизводительных устройствах, модель должна обеспечивать высокую точность и скорость работы при минимальных вычислительных затратах.

Основная проблема заключается в том, что при уменьшении размера или глубины нейронной сети снижается точность распознавания. 

Целью задачи является добиться схожих с неуменьшенными версиями результатов точности при ограниченных вычислительных ресурсах, воздействуя на параметры архитектуры и обрабатываемых данных.

## Параметры задачи

| Категория            | Основные параметры                          | Влияет на                                           |
| -------------------- | ------------------------------------------- | --------------------------------------------------- |
| **Архитектура сети** | количество слоёв, количество фильтров, шаг  | скорость работы (fps), точность и размер модели     |
| **Данные**           | размер входного изображения, баланс классов | точность и способность обобщения                    |
| **Якори (anchors)**  | количество и размеры якорных рамок          | качество локализации объектов                       |
| **Метрики оценки**   | mAP, Precision, Recall, IoU, FPS            | позволяет оценить скорость и точность работы модели |



Можно выделить следующие связи параметров:

* Увеличение разрешения входных данных влечет за собой увеличение точности, но падение скорости обработки (fps)

* Уменьшение числа слоев или фильтров приводит к росту скорости, но падает способность различать сложные и маленькие объекты

* Неоптимальный выбор якорей ухудшает локализацию объектов и снижает IoU

* Оптимизация параметров (увеличение размера изображения, изменение количества якорных рамок) позволяет компенсировать потерю точности при уменьшении сети



## Алгоритм оптимизации сети

### Анализ архитектуры

1. Зафиксировать начальное количество слоёв, шаг

2. Определить параметры, которые можно изменить для достижения поставленной производительности на мобильном устройстве

3. Зафиксировать измененные параметры модели по сравнению с исходной

### Изменение входных данных

1. Изменить размер входного изображения $W_n × H_n$

2. Оценить изменения mAP и fps

3. Описать влияние: 
   $mAP∝f(W_n,H_n​), FPS∝f\frac{(Wn​,Hn​)1}{1}$
   $f - $ функция зависимости точности и скорости от разрешения.​



### Оптимизировать якорные рамки

1. Масштабировать рамки по формуле: 
   $(w_r, h_r) =(\frac{W_n}{W_i}×w_t, \frac{H_n}{H_i}×h_t)$
      



## Кластеризация k-средних с Евклидовым расстоянием

Каждое значение из пары ограничивающих рамок умножается на разницу между заданным разрешением изображения и входным изображением.

$(w_r, h_r) =(\frac{W_n}{W_i}×w_t, \frac{H_n}{H_i}×h_t)$, где:

* $(w_t, h_t)$ - граничные рамки исходного значения (пиксели)

* $(w_r, h_r)$ - ремасштабированные рамки (пиксели)

* $(W_n,H_n)$ - исходное разрешение входа сети (пиксели)

* $(W_i, H_i)$ - ширина и высота входного избражение (пиксели)

Затем получившиеся значения кластеризуют через k-средних по ширине и высоте и получают центроиды кластеров $(w_c, h_c)$ - усредненные размеры рамок

Далее высчитывается количество якорных рамок $k$ с помощью силуэта средних коэффициентов, которое влияет на количество пар $(w_a, h_a)$, которые были получены следующим образом:

$(w_a, h_a) = (\frac{w_c}{feat_{st}}, \frac{h_c}{feat_{st}})$

где $feat_{st}$ - шаг карты признаков, т.к. сеть содержит 5 слоев max pooling с шагом 2, т.е. $2^5$

И по результатам силуэта средних коэффициентов оптимальное значение $k$ вышло $9$

## Результаты

Таким образом это привело к следующим изменениям



## Источники

1. [Real Time Object Detection Based on Deep Neural Network (стр. 493 - 504)](https://link.springer.com/journal/41315)
